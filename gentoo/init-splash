#!/sbin/runscript
# Copyright 1999-2007 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

depend() {
	before xdm
	use localmount
}

set_theme()
{
	local theme=$1
	local tty=$2

	/sbin/splash_util --tty="${tty}" -m v -t "${theme}" -c setcfg || return 1
	/sbin/splash_util --tty="${tty}" -m v -t "${theme}" -c setpic -q
	/sbin/splash_util --tty="${tty}" -c on || return 1

	return 0
}

start() {
	. /sbin/splash-functions.sh
	splash_setup

	if [ -z "${SPLASH_TTYS}" ]; then
		if [ -n "${RC_TTY_NUMBER}" ]; then
			SPLASH_TTYS=$(seq 1 "${RC_TTY_NUMBER}")
		else
			SPLASH_TTYS="1 2 3 4 5 6"
		fi
	fi

	local err=0

	# Only do this if the kernel supports fbsplash.
	if [ -e /dev/fbsplash -a "${SPLASH_MODE_REQ}" != "off" ]; then
		ebegin "Setting framebuffer console images"

		for TTY in ${SPLASH_TTYS} ; do
			theme="${SPLASH_THEME}"

			[ ${TTY} = "1" -a -z "$(/sbin/splash_util -c getstate --tty=${TTY}| grep 'off')" ] && continue
			[ ${TTY} = "0" ] && continue

			if [ -n "${SPLASH_TTY_MAP}" ]; then
				for i in ${SPLASH_TTY_MAP} ; do
					if [ "${i%:*}" = "${TTY}" ]; then
						theme="${i#*:}"
					fi
				done
			fi

			if [ -x /usr/bin/openvt ]; then
				/usr/bin/openvt -c "${TTY}" -- printf "" 2>/dev/null
			fi

			if ! set_theme "${theme}" "${TTY}"; then
				err=1
				break
			fi
		done
		eend "${err}" "Failed to set background image on tty${TTY}"
	fi
}
